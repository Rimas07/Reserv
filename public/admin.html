<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rezervachka - Admin</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f8fafc;color:#111827;line-height:1.5}

/* Login */
.login-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;background:#0f172a}
.login-box{background:#fff;border-radius:16px;padding:36px;width:100%;max-width:400px;box-shadow:0 20px 60px rgba(0,0,0,.3)}
.login-box .brand{text-align:center;margin-bottom:24px}
.login-box .brand-icon{font-size:32px;margin-bottom:8px}
.login-box .brand h1{font-size:20px;font-weight:800;color:#0f172a}
.login-box .brand p{font-size:12px;color:#64748b}

/* Layout */
.layout{display:flex;min-height:100vh}

/* Sidebar */
.sidebar{width:220px;background:#1e293b;color:#fff;padding:0;display:flex;flex-direction:column;flex-shrink:0}
.sidebar .brand{padding:20px 16px;border-bottom:1px solid #334155}
.sidebar .brand h2{font-size:16px;font-weight:800;color:#14b8a6;display:flex;align-items:center;gap:6px}
.sidebar .brand p{font-size:11px;color:#64748b;margin-top:2px}
.sidebar .nav-items{flex:1;padding:8px 0}
.sidebar a{display:flex;align-items:center;gap:10px;padding:11px 16px;color:#94a3b8;text-decoration:none;font-size:13px;cursor:pointer;border-left:3px solid transparent;transition:all .15s}
.sidebar a:hover{background:#334155;color:#e2e8f0}
.sidebar a.active{background:#334155;color:#fff;font-weight:600;border-left-color:#14b8a6}
.sidebar .footer{padding:12px 16px;border-top:1px solid #334155}
.sidebar .logout{color:#ef4444;padding:11px 16px;display:flex;align-items:center;gap:10px;cursor:pointer;font-size:13px;border:none;background:none;width:100%;text-align:left}
.sidebar .logout:hover{background:#334155}
.sidebar .user-info{font-size:11px;color:#64748b;padding:8px 16px}

/* Main */
.main{flex:1;padding:24px;overflow-x:auto}
.section{display:none}
.section.active{display:block}

/* Stats grid */
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px}
.stat-card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,.06)}
.stat-card .stat-top{display:flex;justify-content:space-between;align-items:flex-start}
.stat-card .stat-label{font-size:11px;color:#9ca3af;margin-bottom:4px}
.stat-card .stat-value{font-size:26px;font-weight:800}
.stat-card .stat-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px}

/* Cards */
.card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.06);margin-bottom:16px}
.card-body{padding:20px}
.card-title{font-size:14px;font-weight:700;margin-bottom:14px}

/* Alert section */
.alert-section{background:#f0fdfa;border:2px solid #99f6e4;border-radius:12px;padding:16px;margin-bottom:20px}
.alert-section .alert-title{font-size:14px;font-weight:700;color:#0d9488;margin-bottom:8px}
.alert-row{display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid #d1fae5}
.alert-row:last-child{border:none}
.alert-dot{font-size:8px;color:#14b8a6}
.alert-name{font-size:13px;font-weight:600}
.alert-detail{font-size:12px;color:#6b7280}

/* Tags */
.tag{display:inline-block;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600}

/* Tables */
table{width:100%;border-collapse:collapse;font-size:13px}
thead tr{border-bottom:2px solid #e5e7eb}
th{padding:8px;font-weight:700;color:#6b7280;font-size:10px;text-transform:uppercase;text-align:left}
td{padding:8px;border-bottom:1px solid #f0f2f5}
tr:hover{background:#fafafa}

/* Buttons */
.btn{padding:8px 16px;background:#14b8a6;color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:background .2s}
.btn:hover{background:#0d9488}
.btn-sm{padding:6px 12px;font-size:12px}
.btn-red{background:#ef4444}.btn-red:hover{background:#dc2626}
.btn-green{background:#059669}.btn-green:hover{background:#047857}
.btn-outline{background:transparent;color:#14b8a6;border:2px solid #14b8a6}
.btn-outline:hover{background:#f0fdfa}
.btn-orange{background:#f59e0b}.btn-orange:hover{background:#d97706}

/* Filters */
.filters{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;align-items:end}
.form-group{margin-bottom:0}
.form-group label{display:block;margin-bottom:4px;font-weight:600;font-size:12px;color:#6b7280}
.form-group input,.form-group select{padding:8px 12px;border:1px solid #e5e7eb;border-radius:8px;font-size:12px;background:#fff;min-width:140px}
.form-group input:focus,.form-group select:focus{outline:none;border-color:#14b8a6}

/* Page header */
.page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.page-title{font-size:20px;font-weight:800}
.page-sub{font-size:12px;color:#9ca3af}

/* Modals */
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:100}
.modal-overlay.show{display:flex}
.modal{background:#fff;border-radius:16px;padding:24px;width:100%;max-width:520px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.2)}
.modal h3{font-size:16px;font-weight:700;margin-bottom:16px}
.modal .form-group{margin-bottom:14px}
.modal .form-group input,.modal .form-group select{min-width:auto;width:100%;padding:10px 14px}

/* Slot badges */
.slot-badge{display:inline-block;padding:6px 12px;border-radius:8px;font-size:12px;font-weight:600;margin:3px;cursor:default}
.slot-avail{background:#d1fae5;color:#059669;cursor:pointer;border:1px solid #a7f3d044}
.slot-avail:hover{background:#bbf7d0}
.slot-booked{background:#dbeafe;color:#2563eb;border:1px solid #93c5fd44}
.slot-blocked{background:#f0f2f5;color:#9ca3af;cursor:pointer;border:1px solid #e5e7eb}
.slot-blocked:hover{background:#e5e7eb}

/* Schedule row */
.schedule-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.schedule-row label{width:30px;font-weight:600;font-size:12px;color:#6b7280}
.schedule-row input{width:80px;padding:6px 10px;border:1px solid #e5e7eb;border-radius:6px;font-size:12px}

/* Messages */
.msg{padding:10px 14px;border-radius:8px;margin:8px 0;font-size:13px}
.msg-ok{background:#d1fae5;color:#059669}
.msg-err{background:#fef2f2;color:#991b1b}
.loading{text-align:center;padding:20px;color:#64748b}

/* Legend */
.legend{display:flex;gap:16px;margin-top:12px}
.legend-item{display:flex;align-items:center;gap:6px}
.legend-dot{width:14px;height:14px;border-radius:3px;border:1px solid}

@media(max-width:900px){
  .stats{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen" class="login-wrap">
<div class="login-box">
  <div class="brand">
    <div class="brand-icon">ü©∫</div>
    <h1>Rezervachka Admin</h1>
    <p>Pan√©l administr√°tora kliniky</p>
  </div>
  <form onsubmit="doLogin(event)">
    <div class="form-group" style="margin-bottom:14px"><label>Email</label><input type="email" id="loginEmail" required value="admin@clinic.cz" style="width:100%;padding:10px 14px"></div>
    <div class="form-group" style="margin-bottom:14px"><label>Heslo</label><input type="password" id="loginPass" required value="123456" style="width:100%;padding:10px 14px"></div>
    <div id="loginError" class="msg msg-err" style="display:none"></div>
    <button type="submit" class="btn" style="width:100%;padding:12px;font-size:14px;margin-top:8px">P≈ôihl√°sit se</button>
  </form>
</div>
</div>

<!-- MAIN LAYOUT -->
<div id="appLayout" class="layout" style="display:none">
<nav class="sidebar">
  <div class="brand">
    <h2>ü©∫ Rezervachka</h2>
    <p>Urologick√° klinika</p>
  </div>
  <div class="nav-items">
    <a onclick="showSection('dashboard')" class="active" data-nav="dashboard">üìä Dashboard</a>
    <a onclick="showSection('appointments')" data-nav="appointments">üìã Z√°pisy</a>
    <a onclick="showSection('doctorsSection')" data-nav="doctorsSection">üë®‚Äç‚öïÔ∏è L√©ka≈ôi</a>
    <a onclick="showSection('slotsSection')" data-nav="slotsSection">üìÖ Sloty</a>
  </div>
  <div class="footer">
    <div class="user-info">üë§ admin@clinic.cz</div>
    <button class="logout" onclick="doLogout()">üö™ Odhl√°sit se</button>
  </div>
</nav>

<div class="main">

<!-- Dashboard -->
<div id="dashboard" class="section active">
  <div class="page-header">
    <h2 class="page-title">üìä Dashboard</h2>
    <div class="page-sub" id="todayDate"></div>
  </div>

  <div class="stats">
    <div class="stat-card">
      <div class="stat-top">
        <div><div class="stat-label">Z√°pis≈Ø tento mƒõs√≠c</div><div class="stat-value" id="statTotal" style="color:#14b8a6">-</div></div>
        <div class="stat-icon" style="background:#f0fdfa">üìÖ</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-top">
        <div><div class="stat-label">Voln√© sloty</div><div class="stat-value" id="statFree" style="color:#059669">-</div></div>
        <div class="stat-icon" style="background:#d1fae5">‚úÖ</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-top">
        <div><div class="stat-label">Nov√Ωch dnes</div><div class="stat-value" id="statToday" style="color:#2563eb">-</div></div>
        <div class="stat-icon" style="background:#dbeafe">üÜï</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-top">
        <div><div class="stat-label">Zru≈°eno</div><div class="stat-value" id="statCancelled" style="color:#ef4444">-</div></div>
        <div class="stat-icon" style="background:#fee2e2">‚ùå</div>
      </div>
    </div>
  </div>

  <div class="alert-section" id="newBookingsAlert" style="display:none">
    <div class="alert-title">üîî Nov√© z√°pisy</div>
    <div id="newBookingsBody"></div>
  </div>

  <div class="card">
    <div class="card-body">
      <div class="card-title">üìã Nejbli≈æ≈°√≠ z√°pisy</div>
      <table>
        <thead><tr><th>Datum</th><th>ƒåas</th><th>Pacient</th><th>Telefon</th><th>L√©ka≈ô</th><th>Slu≈æba</th><th>Status</th><th></th></tr></thead>
        <tbody id="recentTable"><tr><td colspan="8" class="loading">Naƒç√≠t√°m...</td></tr></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Appointments -->
<div id="appointments" class="section">
  <div class="page-header">
    <h2 class="page-title">üìã V≈°echny z√°pisy</h2>
    <button class="btn btn-sm btn-green">üì• Export do Excel</button>
  </div>
  <div class="filters">
    <div class="form-group"><label>üîç Hledat</label><input type="text" id="filterSearch" placeholder="Jm√©no nebo telefon"></div>
    <div class="form-group"><label>L√©ka≈ô</label><select id="filterDoctor"><option value="">V≈°ichni</option></select></div>
    <div class="form-group"><label>Status</label><select id="filterStatus"><option value="">V≈°echny</option><option value="confirmed">Potvrzen√©</option><option value="cancelled">Zru≈°en√©</option></select></div>
    <button class="btn" onclick="loadAppointments()">Filtrovat</button>
  </div>
  <div class="card">
    <div class="card-body">
      <table>
        <thead><tr><th>#</th><th>Datum</th><th>ƒåas</th><th>Pacient</th><th>Telefon</th><th>Email</th><th>L√©ka≈ô</th><th>Slu≈æba</th><th>Poji≈°≈•ovna</th><th>Status</th><th>Akce</th></tr></thead>
        <tbody id="apptTable"><tr><td colspan="11" class="loading">Naƒç√≠t√°m...</td></tr></tbody>
      </table>
      <div id="apptPagination" style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
        <span style="font-size:12px;color:#9ca3af" id="apptCount"></span>
      </div>
    </div>
  </div>
</div>

<!-- Doctors -->
<div id="doctorsSection" class="section">
  <div class="page-header">
    <h2 class="page-title">üë®‚Äç‚öïÔ∏è L√©ka≈ôi</h2>
    <button class="btn" onclick="openDoctorModal()">+ P≈ôidat l√©ka≈ôe</button>
  </div>
  <div class="card">
    <div class="card-body">
      <div id="doctorsGrid"></div>
    </div>
  </div>
</div>

<!-- Slots -->
<div id="slotsSection" class="section">
  <div class="page-header">
    <h2 class="page-title">üìÖ Spr√°va slot≈Ø</h2>
  </div>
  <div class="card" style="margin-bottom:16px">
    <div class="card-body">
      <div class="card-title">Generovat sloty</div>
      <div class="filters">
        <div class="form-group"><label>L√©ka≈ô</label><select id="genDoctor"></select></div>
        <div class="form-group"><label>Rok</label><input type="number" id="genYear" value="2026" style="width:80px"></div>
        <div class="form-group"><label>Mƒõs√≠c</label><input type="number" id="genMonth" min="1" max="12" value="3" style="width:60px"></div>
        <button class="btn btn-green" onclick="generateSlots()">Generovat</button>
      </div>
      <div id="genResult"></div>
    </div>
  </div>
  <div class="card">
    <div class="card-body">
      <div class="card-title">Zobrazit sloty</div>
      <div class="filters">
        <div class="form-group"><label>L√©ka≈ô</label><select id="viewSlotsDoctor"></select></div>
        <div class="form-group"><label>Datum</label><input type="date" id="viewSlotsDate"></div>
        <button class="btn" onclick="loadSlots()">Zobrazit</button>
      </div>
      <div id="slotsGrid" style="margin-top:12px"></div>
      <div class="legend" id="slotsLegend" style="display:none">
        <div class="legend-item"><div class="legend-dot" style="background:#d1fae5;border-color:#059669"></div><span style="font-size:11px;color:#6b7280">Voln√©</span></div>
        <div class="legend-item"><div class="legend-dot" style="background:#dbeafe;border-color:#2563eb"></div><span style="font-size:11px;color:#6b7280">Obsazen√©</span></div>
        <div class="legend-item"><div class="legend-dot" style="background:#f0f2f5;border-color:#9ca3af"></div><span style="font-size:11px;color:#6b7280">Blokovan√©</span></div>
      </div>
    </div>
  </div>
</div>

</div>
</div>

<!-- Doctor Modal -->
<div id="doctorModal" class="modal-overlay">
<div class="modal">
  <h3 id="doctorModalTitle">P≈ôidat l√©ka≈ôe</h3>
  <form onsubmit="saveDoctorForm(event)">
    <input type="hidden" id="editDoctorId">
    <div class="form-group"><label>Jm√©no</label><input type="text" id="docName" required></div>
    <div class="form-group"><label>Specializace</label><input type="text" id="docSpec" required value="Urolog"></div>
    <div class="form-group"><label>Jazyky (ƒç√°rkou)</label><input type="text" id="docLangs" value="CZ"></div>
    <div class="form-group"><label>D√©lka slotu (min)</label><input type="number" id="docSlot" value="30"></div>
    <div class="form-group"><label style="margin-bottom:8px">Rozvrh</label>
      <div class="schedule-row"><label>Po</label><input type="text" id="schMonF" placeholder="08:00"><span style="color:#9ca3af">‚Äì</span><input type="text" id="schMonT" placeholder="16:00"></div>
      <div class="schedule-row"><label>√öt</label><input type="text" id="schTueF" placeholder="08:00"><span style="color:#9ca3af">‚Äì</span><input type="text" id="schTueT" placeholder="16:00"></div>
      <div class="schedule-row"><label>St</label><input type="text" id="schWedF" placeholder="08:00"><span style="color:#9ca3af">‚Äì</span><input type="text" id="schWedT" placeholder="12:00"></div>
      <div class="schedule-row"><label>ƒåt</label><input type="text" id="schThuF" placeholder="08:00"><span style="color:#9ca3af">‚Äì</span><input type="text" id="schThuT" placeholder="16:00"></div>
      <div class="schedule-row"><label>P√°</label><input type="text" id="schFriF" placeholder="08:00"><span style="color:#9ca3af">‚Äì</span><input type="text" id="schFriT" placeholder="14:00"></div>
    </div>
    <div id="doctorModalError" class="msg msg-err" style="display:none"></div>
    <div style="display:flex;gap:8px;margin-top:16px">
      <button type="submit" class="btn">Ulo≈æit</button>
      <button type="button" class="btn btn-outline" onclick="closeDoctorModal()">Zru≈°it</button>
    </div>
  </form>
</div>
</div>

<script>
const API='';
let token=localStorage.getItem('adminToken');
let allDoctors=[];

// Set today's date
document.getElementById('todayDate').textContent='Dnes: '+new Date().toLocaleDateString('cs-CZ',{weekday:'long',day:'numeric',month:'long',year:'numeric'});

// --- Auth ---
function checkAuth(){
  if(token){document.getElementById('loginScreen').style.display='none';document.getElementById('appLayout').style.display='flex';loadDashboard();loadDoctorsList()}
}
async function doLogin(e){
  e.preventDefault();
  const err=document.getElementById('loginError');err.style.display='none';
  try{
    const r=await fetch(API+'/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:document.getElementById('loginEmail').value,password:document.getElementById('loginPass').value})});
    const d=await r.json();
    if(!r.ok)throw new Error(d.message||'Chybn√© p≈ôihl√°≈°en√≠');
    token=d.accessToken;localStorage.setItem('adminToken',token);
    document.getElementById('loginScreen').style.display='none';document.getElementById('appLayout').style.display='flex';
    loadDashboard();loadDoctorsList();
  }catch(er){err.textContent=er.message;err.style.display='block'}
}
function doLogout(){token=null;localStorage.removeItem('adminToken');location.reload()}
async function adminFetch(url,opts={}){
  const headers={...opts.headers,'Authorization':'Bearer '+token};
  if(opts.body&&typeof opts.body==='string')headers['Content-Type']='application/json';
  const r=await fetch(API+url,{...opts,headers});
  if(r.status===401){doLogout();throw new Error('Unauthorized')}
  return r;
}

// --- Navigation ---
function showSection(id){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.sidebar a[data-nav]').forEach(a=>a.classList.remove('active'));
  document.querySelector(`[data-nav="${id}"]`)?.classList.add('active');
  if(id==='dashboard')loadDashboard();
  if(id==='appointments')loadAppointments();
  if(id==='doctorsSection')loadDoctorsList();
  if(id==='slotsSection')populateDoctorDropdowns();
}

// --- Dashboard ---
async function loadDashboard(){
  try{
    const r=await adminFetch('/admin/appointments/stats');
    const d=await r.json();
    document.getElementById('statTotal').textContent=d.totalThisMonth||0;
    document.getElementById('statFree').textContent=d.freeSlots||'-';
    document.getElementById('statToday').textContent=d.newToday||0;
    document.getElementById('statCancelled').textContent=d.cancelled||0;

    // New bookings alert
    if(d.recent&&d.recent.length){
      const alertEl=document.getElementById('newBookingsAlert');
      const recentNew=d.recent.filter(a=>a.status==='confirmed').slice(0,3);
      if(recentNew.length){
        alertEl.style.display='block';
        document.getElementById('newBookingsBody').innerHTML=recentNew.map((a,i)=>{
          const doc=a.doctorId||{};const slot=a.slotId||{};
          return `<div class="alert-row">
            <span class="alert-dot">‚óè</span>
            <div style="flex:1">
              <span class="alert-name">${a.patientName}</span>
              <span class="alert-detail"> ‚Üí ${doc.name||'-'} ¬∑ ${slot.date||''} ${slot.startTime||''}</span>
            </div>
            <span class="tag" style="color:#0d9488;background:#ccfbf1">${a.serviceName}</span>
          </div>`;
        }).join('');
      }
    }

    // Recent table
    const tb=document.getElementById('recentTable');
    if(!d.recent||!d.recent.length){tb.innerHTML='<tr><td colspan="8">Zat√≠m ≈æ√°dn√© z√°pisy</td></tr>';return}
    tb.innerHTML=d.recent.map((a,i)=>{
      const slot=a.slotId||{};const doc=a.doctorId||{};
      const stMap={confirmed:{l:'‚úÖ Potvrz.',c:'#059669',bg:'#d1fae5'},cancelled:{l:'‚ùå Zru≈°eno',c:'#ef4444',bg:'#fee2e2'}};
      const st=stMap[a.status]||stMap.confirmed;
      return `<tr>
        <td style="font-weight:600">${slot.date||'-'}</td>
        <td>${slot.startTime||''}</td>
        <td style="font-weight:600">${a.patientName}</td>
        <td style="color:#6b7280;font-size:12px">${a.phone||'-'}</td>
        <td style="color:#6b7280">${doc.name||'-'}</td>
        <td><span class="tag" style="color:#6b7280;background:#f0f2f5">${a.serviceName}</span></td>
        <td><span class="tag" style="color:${st.c};background:${st.bg}">${st.l}</span></td>
        <td><span style="font-size:11px;color:#2563eb;cursor:pointer">Podrobnosti</span></td>
      </tr>`;
    }).join('');
  }catch(e){console.error(e)}
}

// --- Appointments ---
async function loadAppointments(){
  populateDoctorDropdowns();
  const q=new URLSearchParams();
  const doc=document.getElementById('filterDoctor').value;
  const st=document.getElementById('filterStatus').value;
  const se=document.getElementById('filterSearch').value;
  if(doc)q.set('doctorId',doc);if(st)q.set('status',st);if(se)q.set('search',se);
  const tb=document.getElementById('apptTable');
  tb.innerHTML='<tr><td colspan="11" class="loading">Naƒç√≠t√°m...</td></tr>';
  try{
    const r=await adminFetch('/admin/appointments?'+q.toString());
    const data=await r.json();
    if(!data.length){tb.innerHTML='<tr><td colspan="11">≈Ω√°dn√© z√°pisy</td></tr>';return}
    tb.innerHTML=data.map((a,i)=>{
      const slot=a.slotId||{};const doc=a.doctorId||{};
      const stMap={confirmed:{l:'‚úÖ Potvrz.',c:'#059669',bg:'#d1fae5'},cancelled:{l:'‚ùå Zru≈°eno',c:'#ef4444',bg:'#fee2e2'},new:{l:'üÜï Nov√©',c:'#2563eb',bg:'#dbeafe'}};
      const st=stMap[a.status]||stMap.confirmed;
      const cancelBtn=a.status==='confirmed'?`<span style="font-size:11px;color:#ef4444;cursor:pointer" onclick="cancelAppt('${a._id}')">Zru≈°it</span>`:'';
      return `<tr>
        <td style="font-size:11px;color:#9ca3af">${String(i+1).padStart(3,'0')}</td>
        <td style="font-weight:600">${slot.date||'-'}</td>
        <td>${slot.startTime||''}</td>
        <td style="font-weight:600">${a.patientName}</td>
        <td style="font-size:11px;color:#6b7280">${a.phone||'-'}</td>
        <td style="font-size:11px;color:#6b7280">${a.email||'-'}</td>
        <td style="color:#6b7280">${doc.name||'-'}</td>
        <td><span class="tag" style="color:#6b7280;background:#f0f2f5">${a.serviceName}</span></td>
        <td><span class="tag" style="color:#0891b2;background:#cffafe">${a.insurance||'-'}</span></td>
        <td><span class="tag" style="color:${st.c};background:${st.bg}">${st.l}</span></td>
        <td>${cancelBtn}</td>
      </tr>`;
    }).join('');
    document.getElementById('apptCount').textContent=`Zobrazeno ${data.length} z√°pis≈Ø`;
  }catch(e){tb.innerHTML='<tr><td colspan="11" class="msg-err">Chyba</td></tr>'}
}
async function cancelAppt(id){
  if(!confirm('Opravdu chcete zru≈°it tento z√°pis?'))return;
  try{await adminFetch('/admin/appointments/'+id+'/cancel',{method:'PUT'});loadAppointments();loadDashboard()}catch(e){alert('Chyba: '+e.message)}
}

// --- Doctors ---
async function loadDoctorsList(){
  try{
    const r=await fetch(API+'/doctors');
    allDoctors=await r.json();
    const el=document.getElementById('doctorsGrid');
    if(!allDoctors.length){el.innerHTML='<p style="color:#9ca3af;padding:8px">≈Ω√°dn√≠ l√©ka≈ôi</p>';return}
    el.innerHTML=allDoctors.map(d=>{
      const docIcon=(d.languages||[]).some(l=>['RU','UA'].includes(l.toUpperCase()))?'üë©‚Äç‚öïÔ∏è':'üë®‚Äç‚öïÔ∏è';
      const scheduleStr=Object.entries(d.schedule||{}).map(([k,v])=>`${k}: ${v.from}-${v.to}`).join(' ¬∑ ');
      return `<div style="display:flex;align-items:center;gap:16px;padding:14px 0;border-bottom:1px solid #e5e7eb">
        <div style="width:44px;height:44px;border-radius:50%;background:#f0fdfa;display:flex;align-items:center;justify-content:center;font-size:20px;border:1px solid #99f6e4">${docIcon}</div>
        <div style="flex:1">
          <div style="font-size:14px;font-weight:600">${d.name} <span style="font-size:12px;color:#14b8a6;font-weight:600">${d.specialization}</span></div>
          <div style="font-size:12px;color:#6b7280">üó£ ${(d.languages||[]).join(', ')} ¬∑ ‚è± ${d.slotDurationMinutes} min${scheduleStr?' ¬∑ üïê '+scheduleStr:''}</div>
        </div>
        <span class="tag" style="color:${d.isActive?'#059669':'#ef4444'};background:${d.isActive?'#d1fae5':'#fee2e2'}">${d.isActive?'‚úÖ Aktivn√≠':'‚ùå Neaktivn√≠'}</span>
        <button class="btn btn-sm btn-outline" onclick="editDoctor('${d._id}')">Upravit</button>
      </div>`;
    }).join('');
    populateDoctorDropdowns();
  }catch(e){console.error(e)}
}
function populateDoctorDropdowns(){
  ['filterDoctor','genDoctor','viewSlotsDoctor'].forEach(id=>{
    const el=document.getElementById(id);if(!el)return;
    const val=el.value;const hasAll=id==='filterDoctor';
    el.innerHTML=(hasAll?'<option value="">V≈°ichni</option>':'')+allDoctors.map(d=>`<option value="${d._id}">${d.name}</option>`).join('');
    if(val)el.value=val;
  });
}
function openDoctorModal(doc){
  document.getElementById('doctorModalTitle').textContent=doc?'Upravit l√©ka≈ôe':'P≈ôidat l√©ka≈ôe';
  document.getElementById('editDoctorId').value=doc?doc._id:'';
  document.getElementById('docName').value=doc?doc.name:'';
  document.getElementById('docSpec').value=doc?doc.specialization:'Urolog';
  document.getElementById('docLangs').value=doc?(doc.languages||[]).join(', '):'CZ';
  document.getElementById('docSlot').value=doc?doc.slotDurationMinutes:30;
  const sch=doc?.schedule||{};
  [['Mon','mon'],['Tue','tue'],['Wed','wed'],['Thu','thu'],['Fri','fri']].forEach(([ui,key])=>{
    document.getElementById('sch'+ui+'F').value=sch[key]?.from||'';
    document.getElementById('sch'+ui+'T').value=sch[key]?.to||'';
  });
  document.getElementById('doctorModalError').style.display='none';
  document.getElementById('doctorModal').classList.add('show');
}
function closeDoctorModal(){document.getElementById('doctorModal').classList.remove('show')}
function editDoctor(id){const doc=allDoctors.find(d=>d._id===id);if(doc)openDoctorModal(doc)}
async function saveDoctorForm(e){
  e.preventDefault();
  const err=document.getElementById('doctorModalError');err.style.display='none';
  const id=document.getElementById('editDoctorId').value;
  const schedule={};
  [['Mon','mon'],['Tue','tue'],['Wed','wed'],['Thu','thu'],['Fri','fri']].forEach(([ui,key])=>{
    const f=document.getElementById('sch'+ui+'F').value;const t=document.getElementById('sch'+ui+'T').value;
    if(f&&t)schedule[key]={from:f,to:t};
  });
  const body={
    name:document.getElementById('docName').value,
    specialization:document.getElementById('docSpec').value,
    languages:document.getElementById('docLangs').value.split(',').map(s=>s.trim()).filter(Boolean),
    slotDurationMinutes:parseInt(document.getElementById('docSlot').value)||30,
    schedule,isActive:true
  };
  try{
    const url=id?'/admin/doctors/'+id:'/admin/doctors';
    const method=id?'PUT':'POST';
    const r=await adminFetch(url,{method,body:JSON.stringify(body)});
    if(!r.ok){const d=await r.json();throw new Error(d.message||'Chyba')}
    closeDoctorModal();loadDoctorsList();
  }catch(er){err.textContent=er.message;err.style.display='block'}
}

// --- Slots ---
async function generateSlots(){
  const res=document.getElementById('genResult');res.innerHTML='<div class="loading">Generuji...</div>';
  const body={
    doctorId:document.getElementById('genDoctor').value,
    year:parseInt(document.getElementById('genYear').value),
    month:parseInt(document.getElementById('genMonth').value)
  };
  try{
    const r=await adminFetch('/admin/slots/generate',{method:'POST',body:JSON.stringify(body)});
    const d=await r.json();
    res.innerHTML=`<div class="msg msg-ok">‚úÖ Vygenerov√°no ${d.generated||0} slot≈Ø (celkem ${d.total||0})</div>`;
  }catch(e){res.innerHTML=`<div class="msg msg-err">Chyba: ${e.message}</div>`}
}
async function loadSlots(){
  const grid=document.getElementById('slotsGrid');
  const docId=document.getElementById('viewSlotsDoctor').value;
  const date=document.getElementById('viewSlotsDate').value;
  if(!docId||!date){grid.innerHTML='<div class="msg msg-err">Vyberte l√©ka≈ôe a datum</div>';return}
  grid.innerHTML='<div class="loading">Naƒç√≠t√°m...</div>';
  try{
    const r=await adminFetch(`/admin/slots?doctorId=${docId}&date=${date}`);
    const slots=await r.json();
    if(!slots.length){grid.innerHTML='<p style="color:#9ca3af">≈Ω√°dn√© sloty pro tento den</p>';document.getElementById('slotsLegend').style.display='none';return}
    grid.innerHTML=slots.map(s=>{
      if(s.status==='available')return `<span class="slot-badge slot-avail" onclick="blockSlot('${s._id}')" title="Kliknƒõte pro zablokov√°n√≠">‚úÖ ${s.startTime}</span>`;
      if(s.status==='booked')return `<span class="slot-badge slot-booked" title="Obsazeno">üìå ${s.startTime}</span>`;
      return `<span class="slot-badge slot-blocked" onclick="releaseSlot('${s._id}')" title="Kliknƒõte pro uvolnƒõn√≠">üö´ ${s.startTime}</span>`;
    }).join('');
    document.getElementById('slotsLegend').style.display='flex';
  }catch(e){grid.innerHTML=`<div class="msg msg-err">Chyba: ${e.message}</div>`}
}
async function blockSlot(id){
  try{await adminFetch('/admin/slots/'+id+'/block',{method:'PUT'});loadSlots()}catch(e){alert('Chyba: '+e.message)}
}
async function releaseSlot(id){
  try{await adminFetch('/admin/slots/'+id+'/release',{method:'PUT'});loadSlots()}catch(e){alert('Chyba: '+e.message)}
}

checkAuth();
</script>
</body>
</html>
